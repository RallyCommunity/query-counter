<!DOCTYPE html>
<html>
<head>
    <title>TS Query Counter</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(t){var n,i=305419896;for(t=(t=(t=t.replace(/var CHECKSUM = .*;/,"")).replace(/var BUILDER  = .*;/,"")).replace(/\s/g,""),n=0;n<t.length;n++)i+=t.charCodeAt(n)*n;return i},_checkChecksum:function(t){var n=Ext.create("Deft.Deferred"),i=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(t){if(text=t.responseText,CHECKSUM){var e=i._generateChecksum(text);if(CHECKSUM!==e)return void n.resolve(!1)}n.resolve(!0)}}),n.promise},_addToContainer:function(t){var n=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);t.add(n)},afterRender:function(){var t=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var n=this.down("#information");this._addToContainer(n)}t.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(t).then({scope:this,success:function(t){t||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(t){console.log("oops:",t)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var t=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(t=t+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:t})}}});
                Ext.define("Rally.technicalservices.Logger",{constructor:function(t){Ext.apply(this,t)},log:function(t){var o="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",e=[];e=Ext.Array.push(e,[o]),e=Ext.Array.push(e,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,e)}});
                Ext.define("CountVariableSettingsRow",{alias:"widget.countvariablesettingsrow",extend:"Ext.Container",layout:"hbox",cls:"advanced-filter-row",config:{variableName:void 0,artifactType:void 0,query:void 0,addButtonEnabled:!1,removeButtonEnabled:!1},constructor:function(e){this.mergeConfig(e),this.callParent([this.config])},initComponent:function(){this.items=this._getItems(),this.callParent(arguments)},_getItems:function(){if(this._createAddRowButton(),!this.isEmpty){this._createRemoveRowButton(),this._createIdField(),this._createArtifactTypeField(),this._createQueryField();var e=Ext.widget({xtype:"container",layout:"vbox",height:112,flex:1,items:[this.idField,this.artifactTypeField,this.queryField]});return[this.addRowButton,this.removeRowButton,e]}return[this.addRowButton]},getVariableName:function(){return this.idField.getValue()},getArtifactType:function(){return this.artifactTypeField.getValue()},getQuery:function(){return this.queryField.getValue()},disableAddRow:function(){this.addRowButton.addCls("variable-button-disabled"),this.addRowButton.disable()},disableRemoveRow:function(){this.removeRowButton.addCls("variable-button-disabled"),this.removeRowButton.disable()},enableRemoveRow:function(){this.removeRowButton.removeCls("variable-button-disabled"),this.removeRowButton.enable()},enableAddRow:function(){this.addRowButton.removeCls("variable-button-disabled"),this.addRowButton.enable()},isValid:function(){return!!this.idField.getValue()&&!!this.artifactTypeField.getValue()&&this.queryField.validate()},validate:function(){return this.idField.getValue()?this.artifactTypeField.getValue()?this.queryField.getValue()?this.queryField.validate()?null:"Invalid Query.":"Please provide a query.":"Please provide a value for the Artifact Type.":"Please provide a value for the Variable Name."},getCountVariable:function(){if(this.isValid())return{id:this.idField.getValue(),artifactType:this.artifactTypeField.getValue(),query:this.queryField.getValue()}},_createIdField:function(){this.idField=Ext.widget({xtype:"rallytextfield",itemId:"idField",width:"100%",labelAlign:"right",fieldLabel:"Variable Name",labelSeparator:"",emptyText:"Unique Variable Name...",value:this.variableName,margin:"2 0 2 0",validateOnBlur:!0,validator:function(e){return e&&e.length>0},getErrors:function(e){return e&&0!=e.trim().length?[]:["Please provide a value for Variable Name"]},listeners:{validitychange:function(e,t){this.fireEvent("rowvalidate",this)},scope:this}})},_createArtifactTypeField:function(){this.artifactTypeField=Ext.widget({xtype:"tsrecordtypecombobox",itemId:"artifactTypeField",width:"100%",labelAlign:"right",fieldLabel:"Artifact Type",labelSeparator:"",margin:"2 0 2 0",emptyText:"Choose Artifact Type...",value:this.artifactType,valueField:"TypePath",displayField:"Name",validateOnBlur:!0,validateOnChange:!0,validator:function(e){return e&&e.length>0},listeners:{validitychange:function(e,t){this.fireEvent("rowvalidate",this)},scope:this}})},_createQueryField:function(){this.queryField=Ext.widget({xtype:"textarea",width:"100%",labelAlign:"right",labelSeparator:"",fieldLabel:"Query",margin:"2 0 2 0",flex:1,name:"counterQuery",cls:"query-field",plugins:["rallyfieldvalidationui"],emptyText:"Type a Rally Query like ( ObjectID > 0 )...",value:this.query||"(ObjectID > 0)",validateOnBlur:!0,validateOnChange:!1,validator:function(e){if(!e)return"Query is required.";try{return e&&Rally.data.wsapi.Filter.fromQueryString(e),!0}catch(e){return e.message}},listeners:{validitychange:function(){this.fireEvent("rowvalidate",this)},scope:this}})},_createAddRowButton:function(){var e="variable-button-disabled";this.addButtonEnabled&&(e=""),this.addRowButton=Ext.widget({xtype:"rallybutton",itemId:"addRowButton",cls:"rly-small icon-plus filter-row-control variable-button "+e,margin:5,border:0,disabled:!this.addButtonEnabled,listeners:{click:this._addRow,buffer:200,scope:this}})},_createRemoveRowButton:function(){this.removeRowButton=Ext.widget({xtype:"rallybutton",itemId:"removeRowButton",cls:"rly-small icon-minus filter-row-control variable-button",border:0,margin:5,disabled:!1,listeners:{click:this._removeRow,buffer:200,scope:this}})},_addRow:function(){this.fireEvent("addrow",this)},_removeRow:function(e){this.fireEvent("removerow",this,{autoFocus:!1!==e})}});
                Ext.define("CountVariableSettingsComponent",{extend:"Ext.form.field.Base",alias:"widget.countvariablesettings",fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',layout:"vbox",cls:"advanced-filter-panel",header:!1,maxHeight:350,minHeight:50,border:!1,overflowY:"auto",config:{value:void 0},onRender:function(){this.callParent(arguments);var t=this.value;Ext.isString(t)&&(t=Ext.JSON.decode(t)),this._buildItems(t)},_buildItems:function(t){var e=[];this.countVariableRows=[],Ext.Array.each(t,function(i,a){var o=a===t.length-1,n=this._getRowConfig(i);n.addButtonEnabled=o,n.removeButtonEnabled=!0;var s=Ext.widget(n);e.push(s),this.countVariableRows.push(s)},this);var i=this.maxHeight;Ext.isEmpty(e)&&(this._emptyRow=Ext.widget(this._getEmptyRowConfig()),e.push(this._emptyRow),i=this.minHeight),this._countVariableContainer=Ext.widget({xtype:"container",renderTo:this.inputEl,maxHeight:300,height:i,autoScroll:!0,itemId:"countVariableContainer",layout:{type:"vbox",align:"stretch"},cls:"filters-container",items:e}),Ext.isEmpty(e)&&this._countVariableContainer.setHeight(this.minHeight)},_getRowConfig:function(t){return t||(t={}),{xtype:"countvariablesettingsrow",variableName:t.id||"",artifactType:t.artifactType||"HierarchicalRequirement",query:t.query||"",listeners:{addrow:function(){this._addRow(!0)},removerow:this._removeRow,rowvalidate:this._toggleRowButtons,scope:this}}},_getEmptyRowConfig:function(){return{xtype:"countvariablesettingsrow",isEmpty:!0,addButtonEnabled:!0,itemId:"emptyRow",listeners:{addrow:function(){this._addRow(!0)},scope:this}}},_addEmptyRow:function(){this._emptyRow=Ext.widget(this._getEmptyRowConfig()),this._countVariableContainer.add(this._emptyRow),this._countVariableContainer.setHeight(this.minHeight)},_removeEmptyRow:function(){this._emptyRow&&(this._countVariableContainer.remove(this._emptyRow),this._emptyRow.destroy(),this._countVariableContainer.setHeight(this.maxHeight))},_addRow:function(t){Ext.isEmpty(this.countVariableRows)&&this._removeEmptyRow();var e=Ext.widget(this._getRowConfig());this.countVariableRows.push(e),this._countVariableContainer.add(e)},_removeRow:function(t,e){var i=Math.max(0,_.findIndex(this.countVariableRows,t)-1);_.remove(this.countVariableRows,t),this._countVariableContainer.remove(t),Ext.isEmpty(this.countVariableRows)?this._addEmptyRow():e.autoFocus&&this.countVariableRows[i].valueField&&this.countVariableRows[i].queryField.focus();var a=_.last(this.countVariableRows);!Ext.isEmpty(a)&&a.isValid()&&a.enableAddRow(),this._toggleRowButtons(a)},_toggleRowButtons:function(t){Ext.isEmpty(t)||(t.isValid()&&t===_.last(this.countVariableRows)?t.enableAddRow():t.disableAddRow(),1===this.countVariableRows.length||t.enableRemoveRow())},getSubmitData:function(){var t={};return t[this.name]=Ext.JSON.encode(this._getData()),t},_getData:function(){var t=[];return Ext.Array.each(this.countVariableRows,function(e){t.push(e.getCountVariable())}),t},getErrors:function(){var t=[],e=[];return Ext.Array.each(this.countVariableRows,function(i){var a=i.validate();a&&t.push(a),Ext.Array.contains(e,i.getVariableName())?t.push("Duplicate Variable Names {"+i.getVariableName()+"}.  Variable Names must be unique."):e.push(i.getVariableName())}),_.uniq(t)},setValue:function(t){this.callParent(arguments),this._value=t}});
                Ext.define("Rally.technicalservices.RecordTypeComboBox",{extend:"Rally.ui.combobox.ComboBox",alias:"widget.tsrecordtypecombobox",constructor:function(e){var t={defaultSelectionPosition:"last",editable:!1,fieldLabel:"",context:Rally.environment.getContext(),storeConfig:{autoLoad:!1,remoteFilter:!0,model:Ext.identityFn("TypeDefinition"),sorters:{property:"Name",direction:"Asc"},filters:[{property:"Creatable",operator:"=",value:"true"}]}};e.storeConfig&&(delete e.storeConfig.autoLoad,e.storeConfig.additionalFilters&&(t.storeConfig.filters=t.storeConfig.filters.concat(e.storeConfig.additionalFilters))),this.callParent([Ext.Object.merge(t,e)])},initComponent:function(){this.callParent(),Deft.Promise.all([this._loadStore()]).then({success:function(e){this.on("change",this._onValueChange,this),this.onReady({preferencesLoaded:!0,record:this.getRecord()})},scope:this})},onReady:function(e){(e=e||{}).preferencesLoaded&&(this.fireEvent("select",e.record),this.callParent(arguments))},getSelectedType:function(){return this.getTypeFromRef(this.getValue())},getTypeFromRef:function(e){return this.getStore().findRecord("_ref",e)},getTypeWithOrdinal:function(e){return this.getStore().findRecord("Ordinal",e)},getAllTypeNames:function(){return _.map(this.getStore().getRecords(),function(e){return e.get("TypePath")})},_onValueChange:function(e,t){this.savePreference(t)},_loadStore:function(){var e=new Deft.Deferred;return this.store.load({callback:function(t,r,n){n?e.resolve():e.reject()},scope:this}),e.promise},getPreference:function(){var e=new Deft.Deferred;return Rally.data.PreferenceManager.load(Ext.apply(this._getPreferenceConfig(),{success:function(t){e.resolve(t[this._getPreferenceName()])},scope:this})),e.promise},savePreference:function(e){var t={};t[this._getPreferenceName()]=e,Rally.data.PreferenceManager.update(Ext.apply(this._getPreferenceConfig(),{settings:t}))},_getPreferenceConfig:function(){var e={filterByUser:!0,filterByName:this._getPreferenceName()};return this.context.get&&this.context.get("appID")&&(e.appID=this.context.get("appID")),e},_getPreferenceName:function(){return this.preferenceName+"-"+this.context.getWorkspace().ObjectID},_isPrefValueInStore:function(e){return this.store.findRecord(this.valueField,e)}});
                Ext.define("RichTextEditorSettingsField",{alias:"widget.richtexteditorsettingsfield",extend:"Rally.ui.richtext.RichTextEditor",constructPlugins:function(){return this.plugins=_.reject([this.plugins,"rallyrichtexttemplates"]),this.callParent(arguments)},_createResizer:function(){},_drawEditor:function(){var t=this.createClosureEditor();this._createResizer(),t.always(function(){if(this.initialLoadFinished=!0,this._lastValue=this.getValue(),this.getGrowToFitContent()){var t=Ext.get(this.closureEditor.field).select("img");t.elements.length>0?Rally.util.Ui.executeCallbackWhenImagesLoaded(t,this._growToFitContent,this):this._growToFitContent()}this._ieClosureFocusWorkaround(),this.fireEvent("load",this),Ext.defer(function(){this.fireEvent("afterload",this)},1,this)},this)}});
                Ext.define("Rally.technicalservices.querycounter.Settings",{singleton:!0,getFields:function(e){var t=[];return t.push({name:"countVariables",fieldLabel:null,labelAlign:"top",xtype:"countvariablesettings",width:.9*e.width||600,margin:10}),t.push({xtype:"container",margin:"10 70 0 60",html:'<div class="variable-label">Display Text</div><span style="color:#999999;">Enter the text to display in the App.  Use the format of <b>{&lt;Variable Name&gt;}</b> to place the results of the count queries defined above.</span>'}),t.push({name:"html",flex:1,xtype:"richtexteditorsettingsfield",margin:"10 70 0 60",fieldLabel:"Informational Text",resizeable:!1,readyEvent:"afterload"}),t}});
                Ext.define("TSQueryCounter",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},items:[{xtype:"container",itemId:"display_box",tpl:"<tpl>{displayText}</tpl>"}],config:{defaultSettings:{countVariables:[{artifactType:"Defect",query:"( ObjectID > 0 )",id:"defectCount"},{artifactType:"HierarchicalRequirement",query:"( ObjectID > 0 )",id:"storyCount"}],html:"Defects: {defectCount} and Stories: {storyCount}<br/><br/><em>Use the gear to make App Settings...</em>"}},launch:function(){this._validateSettings(),this._reloadModel()},_validateSettings:function(){var t=this._getCountVariables(),e=this.getSetting("html");this.logger.log("setting ",this.getSettings());var i=[];Ext.Array.each(t,function(t){var o=Ext.String.format("{{0}}",t.id);new RegExp(o).exec(e)||i.push("Variable Name "+o+" not used.")}),i.length>0&&Rally.ui.notify.Notifier.showError({message:i.join("<br/>"),allowHTML:!0})},onTimeboxScopeChange:function(t){this.logger.log("onTimeboxScopeChange",t.getQueryFilter().toString()),this._runApp(t)},_timeboxScopeIsValidForArtifactType:function(t,e){if(t){var i=this.models[e];this.logger.log("_timeboxScopeIsValidForArtifactType",t.getType(),i,i.getField("Milestones"),i.getField("Iteration"),i.getField("Release"),t.getQueryFilter().toString());var o="Release";switch(t.getType()){case"iteration":o="Iteration";break;case"milestone":o="Milestones"}return i.getField(o)?(this.logger.log("TimeboxScope",t.getType(),"is valid for",e),!0):(this.logger.log("TimeboxScope",t.getType(),"NOT valid for",e),!1)}return this.logger.log("No Timebox Scope"),!0},_getCountVariables:function(){var t=this.getSetting("countVariables");return Ext.isString(t)&&(t=JSON.parse(t)),t},_getModelNames:function(){var t=this._getCountVariables();this.logger.log("countVariables ",t);var e=Ext.Array.map(t,function(t){return t.artifactType});return _.uniq(e)},_reloadModel:function(){Ext.isEmpty(this._getModelNames())?this._runApp(this.getContext().getTimeboxScope()):Rally.data.ModelFactory.getModels({types:this._getModelNames(),scope:this,success:function(t){this.logger.log("models ",t),this.models=t,this._runApp(this.getContext().getTimeboxScope())}})},_runApp:function(t){var e=this._getCountVariables(),i=[];this.logger.log("_runApp",e),Ext.Array.each(e,function(e){var o=e.artifactType,r=e.query,a=e.id,s=null;t&&this._timeboxScopeIsValidForArtifactType(t,o)&&(s=t.getQueryFilter(),this.logger.log("Using Timebox Scope >>",s.toString())),Ext.isEmpty(r)||(s=s?s.and(Rally.data.wsapi.Filter.fromQueryString(r)):Rally.data.wsapi.Filter.fromQueryString(r)),i.push(this._loadRecordCount(o,s||[],a))},this),i.length>0?(this.setLoading("Counting..."),Deft.Promise.all(i).then({success:this._updateDisplay,failure:this._showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this)):this._updateDisplay()},_showErrorNotification:function(t){this.logger.log("_showErrorNotification",t),Rally.ui.notify.Notifier.showError({message:t})},_loadRecordCount:function(t,e,i){var o=Ext.create("Deft.Deferred"),r=this;return this.logger.log("Starting load: model>>",t,"filters>>",e.toString()),Ext.create("Rally.data.wsapi.Store",{model:t,filters:e,limit:1,pageSize:1}).load({callback:function(t,e,a){var s={};a?(r.logger.log("result:",e),s[i]=e.resultSet.totalRecords||0,o.resolve(s)):(r.logger.log("Failed: ",e),s[i]='<span class="error-counter">#ERROR: '+e.error.errors.join(". ")+"</span>",o.resolve(s))}}),o.promise},_updateDisplay:function(t){t||(t=[]),t=_.reduce(t,function(t,e){return t=_.extend(t,e)},{}),this.logger.log("_updateDisplay",t);var e=this.getSetting("html"),i=new Ext.XTemplate(e);this.removeAll();var o=this.add({xtype:"container",tpl:i,cls:"default-counter"});o.update(t),this._setLinkTargets(o)},_setLinkTargets:function(t){_.each(Ext.dom.Query.select("a",t.getEl().dom),function(t){t.target="_blank"})},isExternal:function(){return void 0===this.getAppId()},getSettingsFields:function(){return Rally.technicalservices.querycounter.Settings.getFields({width:this.getWidth()})},onSettingsUpdate:function(t){this.logger.log("onSettingsUpdate",t),this._runApp()}});

            Rally.launchApp('TSQueryCounter', {
                name:"TS Query Counter",
                parentRepos:"",
                version:"1.0.2"
            });

        });
    </script>


    <style type="text/css">
        .tsinfolink{position:absolute;right:0px;width:14px;height:14px;border-radius:7px;text-align:center;color:white;background:#C0C0C0;border-style:solid;border-width:1px;margin-top:25px;margin-right:5px;cursor:pointer}.error-counter{color:red}.default-counter{font-family:ProximaNova, Helvetica, Arial;font-size:14px}.variable-label{font-family:ProximaNovaSemiBold, Helvetica, Arial;text-transform:uppercase;font-size:11px}.variable-button{border-bottom-left-radius:2px;border-bottom-right-radius:2px;border-top-left-radius:2px;border-top-right-radius:2px;border-bottom-style:none;border-left-style:none;border-right-style:none;border-top-style:none;font-size:16px;padding-top:3px;width:16px;height:33px;line-height:16px;left:21px;background-clip:border-box;background-color:#e6e6e6;border-color:#e6e6e6;color:#00a9e0}.variable-button-disabled{color:#d6d6d6}
    </style>
</head>
<body>
</body>
</html>
